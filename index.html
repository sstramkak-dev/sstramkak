<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>áŸáŸ’á˜á¶ááŸá” á¢áŸŠáŸá…á”áŸ’ášáŸáŸ ááŸ’ášá¶áŸ†á€á€áŸ‹</title>
    <style>
        :root { --primary-green: #1EA647; --hover-green: #168a39; --bg-gray: #f4f7f6; --text-dark: #2d3436; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; height: 100vh; background-color: var(--bg-gray); }
        
        .sidebar { width: 280px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 30px 15px; }
        .sidebar h2 { color: var(--primary-green); text-align: center; font-size: 20px; }
        
        .nav-btn { background: none; border: none; padding: 14px 20px; text-align: left; font-size: 16px; cursor: pointer; border-radius: 12px; margin-bottom: 10px; color: #636e72; }
        .nav-btn.active { background-color: var(--primary-green); color: white; }

        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        /* Table Styles */
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .search-box { display: flex; align-items: center; gap: 8px; }
        .search-box input[type="date"] { padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: #b2bec3; font-size: 12px; border-bottom: 2px solid #f4f7f6; }
        td { padding: 12px; border-bottom: 1px solid #f4f7f6; }

        .btn-icon { border: none; background: none; cursor: pointer; font-size: 18px; padding: 5px; border-radius: 4px; transition: 0.2s; }
        .btn-edit { color: #0984e3; }
        .btn-delete { color: #d63031; }

        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .submit-btn { background: var(--primary-green); color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        
        .reset-btn { background: #eee; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <h2>áŸáŸ’á˜á¶ááŸá” á¢áŸŠáŸá…á”áŸ’ášáŸáŸ ááŸ’ášá¶áŸ†á€á€áŸ‹</h2>
        <button class="nav-btn active">á€á¶ášáŠá¶á€áŸ‹á”áŸ’ášá¶á€áŸ‹</button>
    </nav>

    <main class="main-content">
        <div class="card" style="background: var(--primary-green); color: white; max-width: 300px;">
            <small>áŸá˜áá»á›áŸ’á™áŸášá»á”</small>
            <h1 id="totalBalance">$0.00</h1>
        </div>

        <div style="display: flex; gap: 25px; flex-wrap: wrap;">
            <div class="card" style="flex: 1; min-width: 300px; height: fit-content;">
                <h1 id="formTitle">á€á¶ášáŠá¶á€áŸ‹á”áŸ’ášá¶á€áŸ‹ááŸ’á˜á¸</h1>
                <input type="number" id="depositAmount" placeholder="á”á‰áŸ’á…á¼á›á…áŸ†á“á½á“á‘á¹á€á”áŸ’ášá¶á€áŸ‹">
                <button class="submit-btn" id="saveBtn" onclick="sendToDrive()">ášá€áŸ’áŸá¶á‘á»á€</button>
                <p id="status" style="text-align:center; margin-top:10px; font-size: 14px;"></p>
            </div>

            <div class="card" style="flex: 2; min-width: 400px;">
                <div class="table-header">
                    <h1>á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášááŸ’á˜á¸áŸ—</h1>
                    <div class="search-box">
                        <label style="font-size: 13px; color: #636e72;">áŸáŸ’áœáŸ‚á„ášá€áá¶á˜á€á¶á›á”ášá·á…áŸ’á†áŸá‘:</label>
                        <input type="date" id="dateSearch" onchange="filterTransactions()">
                        <button class="reset-btn" onclick="resetSearch()">á”á„áŸ’á á¶á‰á‘á¶áŸ†á„á¢áŸáŸ‹</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr><th>á€á¶á›á”ášá·á…áŸ’á†áŸá‘</th><th>á…áŸ†á“á½á“</th><th>áŸá€á˜áŸ’á˜á—á¶á–</th></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Use your previous Web App URL here
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx0TSw5-WUwA60UpgxYrF_DQqiUsSTdH39wJS9_uiXqWrpb2a58ZVIdYdnk9wO4QSUcvA/exec";
        let allTransactions = []; // Store data locally for filtering
        let editingFileId = null;

        async function sendToDrive() {
            const amount = document.getElementById('depositAmount').value;
            if (!amount) return;

            const payload = editingFileId 
                ? { action: "UPDATE", fileId: editingFileId, newData: { type: "Deposit", amount: amount, timestamp: new Date().toISOString() } }
                : { type: "Deposit", amount: amount, timestamp: new Date().toISOString() };

            document.getElementById('status').innerText = "â³ á€áŸ†á–á»á„áŠáŸ†áá¾ášá€á¶áš...";
            
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });

            resetForm();
            setTimeout(loadTransactions, 2000);
        }

        async function loadTransactions() {
            try {
                const response = await fetch(WEB_APP_URL);
                allTransactions = await response.json();
                renderTable(allTransactions);
            } catch (e) {
                document.getElementById('tableBody').innerHTML = "<tr><td colspan='3'>Error loading data.</td></tr>";
            }
        }

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = "";
            let total = 0;

            data.forEach(item => {
                total += parseFloat(item.amount);
                const dateObj = new Date(item.timestamp);
                tableBody.innerHTML += `
                    <tr>
                        <td>${dateObj.toLocaleDateString()}</td>
                        <td style="font-weight:bold; color:var(--primary-green)">$${parseFloat(item.amount).toLocaleString()}</td>
                        <td>
                            <button class="btn-icon btn-edit" title="á€áŸ‚á”áŸ’ášáŸ‚" onclick="editRow('${item.fileId}', '${item.amount}')">âœ</button>
                            <button class="btn-icon btn-delete" title="á›á»á”" onclick="deleteRow('${item.fileId}')">ğŸ—‘</button>
                        </td>
                    </tr>`;
            });
            document.getElementById('totalBalance').innerText = `$${total.toLocaleString()}`;
        }

        function filterTransactions() {
            const searchDate = document.getElementById('dateSearch').value; // Format: YYYY-MM-DD
            if (!searchDate) {
                renderTable(allTransactions);
                return;
            }

            const filtered = allTransactions.filter(item => {
                const itemDate = new Date(item.timestamp).toISOString().split('T')[0];
                return itemDate === searchDate;
            });
            renderTable(filtered);
        }

        function resetSearch() {
            document.getElementById('dateSearch').value = "";
            renderTable(allTransactions);
        }

        async function deleteRow(id) {
            if (!confirm("áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á›á»á”á˜áŸ‚á“á‘áŸ?")) return;
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "DELETE", fileId: id }) });
            setTimeout(loadTransactions, 2000);
        }

        function editRow(id, amount) {
            editingFileId = id;
            document.getElementById('depositAmount').value = amount;
            document.getElementById('formTitle').innerText = "á€áŸ‚á”áŸ’ášáŸ‚á‘á·á“áŸ’á“á“áŸá™";
            document.getElementById('saveBtn').innerText = "á’áŸ’áœá¾á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–";
            window.scrollTo(0,0);
        }

        function resetForm() {
            editingFileId = null;
            document.getElementById('depositAmount').value = "";
            document.getElementById('formTitle').innerText = "á€á¶ášáŠá¶á€áŸ‹á”áŸ’ášá¶á€áŸ‹ááŸ’á˜á¸";
            document.getElementById('saveBtn').innerText = "ášá€áŸ’áŸá¶á‘á»á€";
            document.getElementById('status').innerText = "âœ… ášá½á…ášá¶á›áŸ‹";
        }

        window.onload = loadTransactions;
    </script>
</body>
</html>
