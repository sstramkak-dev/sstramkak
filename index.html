<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>áŸáŸ’á˜á¶ááŸá” á¢áŸŠáŸá…á”áŸ’ášáŸáŸ ááŸ’ášá¶áŸ†á€á€áŸ‹</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Kantumruy+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-green: #1EA647;
            --hover-green: #168a39;
            --bg-gray: #f8fafc;
            --text-main: #1e293b;
            --text-light: #64748b;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        body {
            margin: 0;
            font-family: 'Kantumruy Pro', 'Inter', sans-serif;
            display: flex;
            height: 100vh;
            background-color: var(--bg-gray);
            color: var(--text-main);
        }

        .sidebar { width: 280px; background: var(--white); border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; padding: 40px 20px; }
        .sidebar h2 { color: var(--primary-green); font-size: 22px; font-weight: 700; margin-bottom: 40px; text-align: center; line-height: 1.4; }

        .nav-btn { background: none; border: none; padding: 14px 18px; text-align: left; font-size: 16px; font-weight: 600; cursor: pointer; border-radius: 12px; margin-bottom: 10px; color: var(--text-light); transition: 0.2s; }
        .nav-btn.active { background-color: var(--primary-green); color: white; box-shadow: 0 10px 15px -3px rgba(30, 166, 71, 0.3); }

        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .card { background: var(--white); padding: 28px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 30px; border: 1px solid #f1f5f9; }

        .balance-card { background: linear-gradient(135deg, var(--primary-green) 0%, #15803d 100%); color: white; max-width: 320px; }
        .balance-card small { opacity: 0.8; font-size: 14px; text-transform: uppercase; }
        .balance-card h1 { margin: 10px 0 0; font-size: 32px; font-weight: 700; }

        .grid { display: flex; gap: 30px; flex-wrap: wrap; }
        .form-container { flex: 1; min-width: 320px; }
        .table-container { flex: 2; min-width: 500px; }

        label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 5px; color: var(--text-main); }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1.5px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-family: inherit; font-size: 15px; }
        input:focus { outline: none; border-color: var(--primary-green); }

        .submit-btn { background: var(--primary-green); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: 700; font-size: 16px; font-family: inherit; }
        .submit-btn:hover { background: var(--hover-green); }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: var(--text-light); font-size: 12px; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }

        .btn-icon { border: none; background: #f8fafc; cursor: pointer; font-size: 16px; padding: 8px; border-radius: 8px; margin-left: 5px; transition: 0.2s; }
        .btn-edit { color: #2563eb; }
        .btn-delete { color: #dc2626; }
        
        .remark-text { font-size: 12px; color: var(--text-light); font-style: italic; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <h2>áŸáŸ’á˜á¶ááŸá” á¢áŸŠáŸá…á”áŸ’ášáŸáŸ<br>ááŸ’ášá¶áŸ†á€á€áŸ‹</h2>
        <button class="nav-btn active">ğŸ“Š á€á¶ášáŠá¶á€áŸ‹á”áŸ’ášá¶á€áŸ‹</button>
        <button class="nav-btn">âš™ï¸ á€á¶ášá€áŸ†áááŸ‹</button>
    </nav>

    <main class="main-content">
        <div class="card balance-card">
            <small>áŸá˜áá»á›áŸ’á™áŸášá»á” (Total Balance)</small>
            <h1 id="totalBalance">$0.00</h1>
        </div>

        <div class="grid">
            <div class="card form-container">
                <h1 id="formTitle">á€á¶ášáŠá¶á€áŸ‹á”áŸ’ášá¶á€áŸ‹ááŸ’á˜á¸</h1>
                
                <label>áŸá¶á…áŸ‹á”áŸ’ášá¶á€áŸ‹ (Cash $)</label>
                <input type="number" id="cashInput" placeholder="0.00">
                
                <label>á‡áŸ†á–á¶á€áŸ‹ (Credit $)</label>
                <input type="number" id="creditInput" placeholder="0.00">
                
                <label>á…áŸ†áá¶áŸ† (Remark)</label>
                <input type="text" id="remarkInput" placeholder="á”á‰áŸ’á‡á¶á€áŸ‹á•áŸ’áŸáŸá„áŸ—...">
                
                <button class="submit-btn" id="saveBtn" onclick="sendToDrive()">ášá€áŸ’áŸá¶á‘á»á€á‘á·á“áŸ’á“á“áŸá™</button>
                <span id="status" style="display:block; text-align:center; margin-top:15px; font-size:14px;"></span>
            </div>

            <div class="card table-container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h1>á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášááŸ’á˜á¸áŸ—</h1>
                    <input type="date" id="dateSearch" onchange="filterTransactions()" style="width:auto; margin:0; padding:8px;">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>á€á¶á›á”ášá·á…áŸ’á†áŸá‘</th>
                            <th>áŸá¶á…áŸ‹á”áŸ’ášá¶á€áŸ‹</th>
                            <th>á‡áŸ†á–á¶á€áŸ‹</th>
                            <th>á…áŸ†áá¶áŸ†</th>
                            <th style="text-align:right;">áŸá€á˜áŸ’á˜á—á¶á–</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx0TSw5-WUwA60UpgxYrF_DQqiUsSTdH39wJS9_uiXqWrpb2a58ZVIdYdnk9wO4QSUcvA/exec";
        let allTransactions = []; 
        let editingFileId = null;

        async function sendToDrive() {
            const cash = document.getElementById('cashInput').value || 0;
            const credit = document.getElementById('creditInput').value || 0;
            const remark = document.getElementById('remarkInput').value || "";

            if (cash == 0 && credit == 0) return alert("áŸá¼á˜á”á‰áŸ’á…á¼á›á…áŸ†á“á½á“á‘á¹á€á”áŸ’ášá¶á€áŸ‹");

            const payload = editingFileId 
                ? { action: "UPDATE", fileId: editingFileId, newData: { cash, credit, remark, timestamp: new Date().toISOString() } }
                : { cash, credit, remark, timestamp: new Date().toISOString() };

            document.getElementById('status').innerText = "â³ á€áŸ†á–á»á„ášá€áŸ’áŸá¶á‘á»á€...";
            
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
            resetForm();
            setTimeout(loadTransactions, 2000); 
        }

        async function loadTransactions() {
            const response = await fetch(WEB_APP_URL);
            const rawData = await response.json();
            allTransactions = rawData.filter(item => item && (item.cash || item.credit));
            renderTable(allTransactions);
        }

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            const balanceEl = document.getElementById('totalBalance');
            tableBody.innerHTML = "";
            let grandTotal = 0;

            data.forEach(item => {
                const c = parseFloat(item.cash) || 0;
                const cr = parseFloat(item.credit) || 0;
                grandTotal += (c + cr);

                tableBody.innerHTML += `
                    <tr>
                        <td style="font-weight:600;">${new Date(item.timestamp).toLocaleDateString('km-KH')}</td>
                        <td style="color:var(--primary-green); font-weight:700;">$${c.toLocaleString()}</td>
                        <td style="color:#e67e22; font-weight:700;">$${cr.toLocaleString()}</td>
                        <td class="remark-text">${item.remark || '-'}</td>
                        <td style="text-align:right;">
                            <button class="btn-icon btn-edit" onclick="editRow('${item.fileId}', '${item.cash}', '${item.credit}', '${item.remark}')">âœ</button>
                            <button class="btn-icon btn-delete" onclick="deleteRow('${item.fileId}')">ğŸ—‘</button>
                        </td>
                    </tr>`;
            });
            balanceEl.innerText = `$${grandTotal.toLocaleString()}`;
        }

        async function deleteRow(id) {
            if (!confirm("áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á›á»á”á˜áŸ‚á“á‘áŸ?")) return;
            await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "DELETE", fileId: id }) });
            loadTransactions();
        }

        function editRow(id, cash, credit, remark) {
            editingFileId = id;
            document.getElementById('cashInput').value = cash;
            document.getElementById('creditInput').value = credit;
            document.getElementById('remarkInput').value = remark;
            document.getElementById('formTitle').innerText = "á€áŸ‚á”áŸ’ášáŸ‚á‘á·á“áŸ’á“á“áŸá™";
            document.getElementById('saveBtn').innerText = "á’áŸ’áœá¾á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–";
        }

        function resetForm() {
            editingFileId = null;
            document.getElementById('cashInput').value = "";
            document.getElementById('creditInput').value = "";
            document.getElementById('remarkInput').value = "";
            document.getElementById('formTitle').innerText = "á€á¶ášáŠá¶á€áŸ‹á”áŸ’ášá¶á€áŸ‹ááŸ’á˜á¸";
            document.getElementById('saveBtn').innerText = "ášá€áŸ’áŸá¶á‘á»á€";
            document.getElementById('status').innerText = "âœ… ášá½á…ášá¶á›áŸ‹";
        }

        function filterTransactions() {
            const date = document.getElementById('dateSearch').value;
            if (!date) return renderTable(allTransactions);
            const filtered = allTransactions.filter(item => new Date(item.timestamp).toISOString().split('T')[0] === date);
            renderTable(filtered);
        }

        window.onload = loadTransactions;
    </script>
</body>
</html>
