<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>áŸáŸ’á˜á¶ááŸá” á¢áŸŠáŸá…á”áŸ’ášáŸáŸ ááŸ’ášá¶áŸ†á€á€áŸ‹</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Kantumruy+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-green: #1EA647;
            --hover-green: #168a39;
            --bg-gray: #f8fafc;
            --text-main: #1e293b;
            --text-light: #64748b;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        body {
            margin: 0;
            font-family: 'Kantumruy Pro', 'Inter', sans-serif;
            display: flex;
            height: 100vh;
            background-color: var(--bg-gray);
            color: var(--text-main);
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 280px;
            background: var(--white);
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            padding: 40px 20px;
        }

        .sidebar h2 {
            color: var(--primary-green);
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 40px;
            text-align: center;
            line-height: 1.4;
        }

        .nav-btn {
            background: none;
            border: none;
            padding: 14px 18px;
            text-align: left;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.2s;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-btn:hover {
            background-color: #f1f5f9;
            color: var(--primary-green);
        }

        .nav-btn.active {
            background-color: var(--primary-green);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(30, 166, 71, 0.3);
        }

        /* --- Main Content --- */
        .main-content {
            flex-grow: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .card {
            background: var(--white);
            padding: 28px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid #f1f5f9;
        }

        .balance-card {
            background: linear-gradient(135deg, var(--primary-green) 0%, #15803d 100%);
            color: white;
            max-width: 320px;
            position: relative;
            overflow: hidden;
        }

        .balance-card small { opacity: 0.8; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .balance-card h1 { margin: 10px 0 0; font-size: 32px; font-weight: 700; }

        /* --- Form & Table --- */
        .grid { display: flex; gap: 30px; flex-wrap: wrap; }
        .form-container { flex: 1; min-width: 320px; height: fit-content; }
        .table-container { flex: 2; min-width: 450px; }

        h1 { font-size: 20px; margin-bottom: 20px; font-weight: 700; }

        input {
            width: 100%;
            padding: 14px;
            margin: 12px 0;
            border: 1.5px solid #e2e8f0;
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        input:focus { outline: none; border-color: var(--primary-green); }

        .submit-btn {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            font-weight: 700;
            font-size: 16px;
            font-family: inherit;
            transition: background 0.2s;
        }

        .submit-btn:hover { background: var(--hover-green); }

        /* --- Table Styling --- */
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .search-group { display: flex; align-items: center; gap: 10px; }
        .search-group input[type="date"] { width: auto; padding: 8px 12px; margin: 0; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; color: var(--text-light); font-size: 13px; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; }
        td { padding: 18px 15px; border-bottom: 1px solid #f1f5f9; font-size: 15px; }

        .btn-icon { border: none; background: #f8fafc; cursor: pointer; font-size: 16px; padding: 10px; border-radius: 10px; transition: 0.2s; margin-left: 5px; }
        .btn-edit { color: #2563eb; }
        .btn-delete { color: #dc2626; }
        .btn-icon:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

        #status { font-weight: 600; font-size: 14px; margin-top: 15px; display: block; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <h2>áŸáŸ’á˜á¶ááŸá” á¢áŸŠáŸá…á”áŸ’ášáŸáŸ<br>ááŸ’ášá¶áŸ†á€á€áŸ‹</h2>
        <button class="nav-btn active">ğŸ“Š á€á¶ášáŠá¶á€áŸ‹á”áŸ’ášá¶á€áŸ‹</button>
        <button class="nav-btn">âš™ï¸ á€á¶ášá€áŸ†áááŸ‹</button>
    </nav>

    <main class="main-content">
        <div class="card balance-card">
            <small>áŸá˜áá»á›áŸ’á™áŸášá»á” (Total Balance)</small>
            <h1 id="totalBalance">$0.00</h1>
        </div>

        <div class="grid">
            <div class="card form-container">
                <h1 id="formTitle">á€á¶ášáŠá¶á€áŸ‹á”áŸ’ášá¶á€áŸ‹ááŸ’á˜á¸</h1>
                <label style="font-size: 14px; font-weight: 600;">á…áŸ†á“á½á“á‘á¹á€á”áŸ’ášá¶á€áŸ‹ ($)</label>
                <input type="number" id="depositAmount" placeholder="0.00">
                <button class="submit-btn" id="saveBtn" onclick="sendToDrive()">ášá€áŸ’áŸá¶á‘á»á€á‘á·á“áŸ’á“á“áŸá™</button>
                <span id="status" style="text-align: center; color: var(--text-light);"></span>
            </div>

            <div class="card table-container">
                <div class="table-header">
                    <h1>á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášááŸ’á˜á¸áŸ—</h1>
                    <div class="search-group">
                        <input type="date" id="dateSearch" onchange="filterTransactions()">
                        <button onclick="resetSearch()" style="background:none; border:none; color:var(--primary-green); cursor:pointer; font-size:14px; font-weight:600;">á”á„áŸ’á á¶á‰á‘á¶áŸ†á„á¢áŸáŸ‹</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>á€á¶á›á”ášá·á…áŸ’á†áŸá‘</th>
                            <th>á…áŸ†á“á½á“á‘á¹á€á”áŸ’ášá¶á€áŸ‹</th>
                            <th style="text-align: right;">áŸá€á˜áŸ’á˜á—á¶á–</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx0TSw5-WUwA60UpgxYrF_DQqiUsSTdH39wJS9_uiXqWrpb2a58ZVIdYdnk9wO4QSUcvA/exec";
        let allTransactions = []; 
        let editingFileId = null;

        async function sendToDrive() {
            const amount = document.getElementById('depositAmount').value;
            if (!amount) return;

            const payload = editingFileId 
                ? { action: "UPDATE", fileId: editingFileId, newData: { type: "Deposit", amount: amount, timestamp: new Date().toISOString() } }
                : { type: "Deposit", amount: amount, timestamp: new Date().toISOString() };

            document.getElementById('status').innerText = "â³ á€áŸ†á–á»á„áŠáŸ†áá¾ášá€á¶áš...";
            
            try {
                await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
                resetForm();
                setTimeout(loadTransactions, 2500); 
            } catch(e) {
                document.getElementById('status').innerText = "âŒ á˜á¶á“á”á‰áŸ’á á¶!";
            }
        }

        async function loadTransactions() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = "<tr><td colspan='3' style='text-align:center'>á€áŸ†á–á»á„á•áŸ’á‘á»á€...</td></tr>";

            try {
                const response = await fetch(WEB_APP_URL);
                const rawData = await response.json();
                allTransactions = rawData.filter(item => item && item.amount);
                renderTable(allTransactions);
            } catch (e) {
                tableBody.innerHTML = "<tr><td colspan='3' style='text-align:center'>á˜á·á“á¢á¶á…á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™á”á¶á“á‘áŸáŸ”</td></tr>";
            }
        }

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            const balanceEl = document.getElementById('totalBalance');
            tableBody.innerHTML = "";
            let total = 0;

            if (!data || data.length === 0) {
                tableBody.innerHTML = "<tr><td colspan='3' style='text-align:center; padding: 40px; color: #94a3b8;'>á˜á·á“á‘á¶á“áŸ‹á˜á¶á“á‘á·á“áŸ’á“á“áŸá™á“áŸ…á¡á¾á™</td></tr>";
                balanceEl.innerText = "$0.00";
                return;
            }

            data.forEach(item => {
                const amountValue = parseFloat(item.amount) || 0;
                total += amountValue;

                let dateDisplay = "N/A";
                if (item.timestamp) {
                    const d = new Date(item.timestamp);
                    if (!isNaN(d.getTime())) {
                        dateDisplay = d.toLocaleDateString('km-KH');
                    }
                }

                tableBody.innerHTML += `
                    <tr>
                        <td style="font-weight: 600;">${dateDisplay}</td>
                        <td style="font-weight: 700; color: var(--primary-green); font-size: 16px;">$${amountValue.toLocaleString()}</td>
                        <td style="text-align: right;">
                            <button class="btn-icon btn-edit" title="á€áŸ‚á”áŸ’ášáŸ‚" onclick="editRow('${item.fileId}', '${item.amount}')">âœ</button>
                            <button class="btn-icon btn-delete" title="á›á»á”" onclick="deleteRow('${item.fileId}')">ğŸ—‘</button>
                        </td>
                    </tr>`;
            });
            balanceEl.innerText = `$${total.toLocaleString()}`;
        }

        async function deleteRow(id) {
            if (!id || !confirm("áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á›á»á”á˜áŸ‚á“á‘áŸ?")) return;
            document.getElementById('status').innerText = "ğŸ—‘ á€áŸ†á–á»á„á›á»á”...";
            
            try {
                await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "DELETE", fileId: id }) });
                allTransactions = allTransactions.filter(t => t.fileId !== id);
                renderTable(allTransactions);
                document.getElementById('status').innerText = "âœ… á›á»á”ášá½á…ášá¶á›áŸ‹";
            } catch (e) {
                alert("á€áŸ†á á»áŸá”á…áŸ’á…áŸá€á‘áŸáŸ! áŸá¼á˜á–áŸ’á™á¶á™á¶á˜á˜áŸ’áá„á‘áŸ€ááŸ”");
            }
        }

        function filterTransactions() {
            const searchDate = document.getElementById('dateSearch').value;
            if (!searchDate) { renderTable(allTransactions); return; }
            const filtered = allTransactions.filter(item => {
                const itemDate = new Date(item.timestamp).toISOString().split('T')[0];
                return itemDate === searchDate;
            });
            renderTable(filtered);
        }

        function resetSearch() {
            document.getElementById('dateSearch').value = "";
            renderTable(allTransactions);
        }

        function editRow(id, amount) {
            editingFileId = id;
            document.getElementById('depositAmount').value = amount;
            document.getElementById('formTitle').innerText = "á€áŸ‚á”áŸ’ášáŸ‚á‘á·á“áŸ’á“á“áŸá™";
            document.getElementById('saveBtn').innerText = "á’áŸ’áœá¾á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–";
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function resetForm() {
            editingFileId = null;
            document.getElementById('depositAmount').value = "";
            document.getElementById('formTitle').innerText = "á€á¶ášáŠá¶á€áŸ‹á”áŸ’ášá¶á€áŸ‹ááŸ’á˜á¸";
            document.getElementById('saveBtn').innerText = "ášá€áŸ’áŸá¶á‘á»á€á‘á·á“áŸ’á“á“áŸá™";
            document.getElementById('status').innerText = "âœ… ášá½á…ášá¶á›áŸ‹";
        }

        window.onload = loadTransactions;
    </script>
</body>
</html>
