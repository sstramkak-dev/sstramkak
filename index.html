<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>áŸáŸ’á˜á¶ááŸá” á¢áŸŠáŸá…á”áŸ’ášáŸáŸ ááŸ’ášá¶áŸ†á€á€áŸ‹</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Kantumruy+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-green: #1EA647; --hover-green: #168a39; --bg-gray: #f8fafc; --text-main: #1e293b; --text-light: #64748b; }
        body { margin: 0; font-family: 'Kantumruy Pro', 'Inter', sans-serif; display: flex; height: 100vh; background-color: var(--bg-gray); color: var(--text-main); }
        .sidebar { width: 280px; background: white; border-right: 1px solid #e2e8f0; padding: 40px 20px; }
        .sidebar h2 { color: var(--primary-green); text-align: center; font-size: 20px; margin-bottom: 40px; }
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 25px; }
        .balance-card { background: linear-gradient(135deg, var(--primary-green), #15803d); color: white; max-width: 320px; }
        .grid { display: flex; gap: 25px; flex-wrap: wrap; }
        label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1.5px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-family: inherit; }
        .submit-btn { background: var(--primary-green); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: 700; font-size: 16px; font-family: inherit; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: var(--text-light); border-bottom: 2px solid #f1f5f9; font-size: 13px; }
        td { padding: 15px 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .btn-icon { border: none; background: #f1f5f9; cursor: pointer; font-size: 16px; padding: 8px; border-radius: 8px; margin-left: 5px; }
        .btn-edit { color: #2563eb; }
        .btn-delete { color: #dc2626; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <h2>áŸáŸ’á˜á¶ááŸá” á¢áŸŠáŸá…á”áŸ’ášáŸáŸ<br>ááŸ’ášá¶áŸ†á€á€áŸ‹</h2>
    </nav>

    <main class="main-content">
        <div class="card balance-card">
            <small>áŸá˜áá»á›áŸ’á™áŸášá»á” (Total Balance)</small>
            <h1 id="totalBalance">$0.00</h1>
        </div>

        <div class="grid">
            <div class="card" style="flex: 1; min-width: 320px;">
                <h1 id="formTitle">á€á¶ášáŠá¶á€áŸ‹á”áŸ’ášá¶á€áŸ‹ááŸ’á˜á¸</h1>
                <label>áŸá¶á…áŸ‹á”áŸ’ášá¶á€áŸ‹ ($)</label><input type="number" id="cashInput" placeholder="0.00">
                <label>á‡áŸ†á–á¶á€áŸ‹ ($)</label><input type="number" id="creditInput" placeholder="0.00">
                <label>á…áŸ†áá¶áŸ†</label><input type="text" id="remarkInput" placeholder="...">
                <button class="submit-btn" id="saveBtn" onclick="sendToDrive()">ášá€áŸ’áŸá¶á‘á»á€</button>
                <p id="status" style="text-align:center; font-size:14px; margin-top:10px; font-weight:bold;"></p>
            </div>

            <div class="card" style="flex: 2; min-width: 450px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h1>á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášááŸ’á˜á¸áŸ—</h1>
                    <input type="date" id="dateSearch" onchange="filterTransactions()" style="width:auto; margin:0; padding:8px;">
                </div>
                <table>
                    <thead>
                        <tr><th>á€á¶á›á”ášá·á…áŸ’á†áŸá‘</th><th>áŸá¶á…áŸ‹á”áŸ’ášá¶á€áŸ‹</th><th>á‡áŸ†á–á¶á€áŸ‹</th><th>á…áŸ†áá¶áŸ†</th><th style="text-align:right;">áŸá€á˜áŸ’á˜á—á¶á–</th></tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="5" style="text-align:center">á€áŸ†á–á»á„á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxPPjccMG1Khugas4r7GdcfBKoFwcWYauQN0sayOg8ksy0XQtCckGJSqGYwroow-6RB6g/exec";
        let allTransactions = [];
        let editingFileId = null;

        async function loadTransactions() {
            try {
                const response = await fetch(WEB_APP_URL);
                const data = await response.json();
                
                // Ensure data is an array
                allTransactions = Array.isArray(data) ? data : [];
                renderTable(allTransactions);
            } catch (e) {
                console.error("Fetch Error:", e);
                document.getElementById('tableBody').innerHTML = "<tr><td colspan='5' style='text-align:center; color:red;'>á€áŸ†á á»áŸá”á…áŸ’á…áŸá€á‘áŸáŸáŸ– á˜á·á“á¢á¶á…á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™á”á¶á“á‘áŸáŸ”</td></tr>";
            }
        }

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            let total = 0;
            tableBody.innerHTML = "";

            if (data.length === 0) {
                tableBody.innerHTML = "<tr><td colspan='5' style='text-align:center'>á˜á·á“á‘á¶á“áŸ‹á˜á¶á“á‘á·á“áŸ’á“á“áŸá™á“áŸ…á¡á¾á™</td></tr>";
                document.getElementById('totalBalance').innerText = "$0.00";
                return;
            }

            data.forEach(item => {
                const c = parseFloat(item.cash || 0);
                const cr = parseFloat(item.credit || 0);
                total += (c + cr);
                
                // Safety check for date
                let dateStr = "N/A";
                if(item.timestamp) {
                    const d = new Date(item.timestamp);
                    dateStr = isNaN(d) ? "N/A" : d.toLocaleDateString('km-KH');
                }

                tableBody.innerHTML += `
                    <tr>
                        <td style="font-weight:600;">${dateStr}</td>
                        <td style="color:var(--primary-green); font-weight:700;">$${c.toLocaleString()}</td>
                        <td style="color:orange; font-weight:700;">$${cr.toLocaleString()}</td>
                        <td style="color:var(--text-light); font-style:italic;">${item.remark || '-'}</td>
                        <td style="text-align:right;">
                            <button class="btn-icon btn-edit" title="á€áŸ‚á”áŸ’ášáŸ‚" onclick="editRow('${item.fileId}', ${c}, ${cr}, '${item.remark || ''}')">âœ</button>
                            <button class="btn-icon btn-delete" title="á›á»á”" onclick="deleteRow('${item.fileId}')">ğŸ—‘</button>
                        </td>
                    </tr>`;
            });
            document.getElementById('totalBalance').innerText = `$${total.toLocaleString()}`;
        }

        async function sendToDrive() {
            const cash = document.getElementById('cashInput').value;
            const credit = document.getElementById('creditInput').value;
            const remark = document.getElementById('remarkInput').value;

            if(!cash && !credit) { alert("áŸá¼á˜á”á‰áŸ’á…á¼á›á‘á¹á€á”áŸ’ášá¶á€áŸ‹"); return; }

            const payload = editingFileId 
                ? { action: "UPDATE", fileId: editingFileId, newData: { cash, credit, remark, timestamp: new Date().toISOString() } }
                : { cash, credit, remark, timestamp: new Date().toISOString() };

            document.getElementById('status').innerText = "â³ á€áŸ†á–á»á„ášá€áŸ’áŸá¶á‘á»á€...";
            
            try {
                await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
                resetForm();
                setTimeout(loadTransactions, 2000);
            } catch (e) {
                document.getElementById('status').innerText = "âŒ á”ášá¶á‡áŸá™";
            }
        }

        async function deleteRow(id) {
            if (!confirm("áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á›á»á”á˜áŸ‚á“á‘áŸ?")) return;
            document.getElementById('status').innerText = "ğŸ—‘ á€áŸ†á–á»á„á›á»á”...";
            
            try {
                await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "DELETE", fileId: id }) });
                allTransactions = allTransactions.filter(t => t.fileId !== id);
                renderTable(allTransactions);
                document.getElementById('status').innerText = "âœ… á›á»á”ášá½á…ášá¶á›áŸ‹";
            } catch (e) {
                alert("á˜á·á“á¢á¶á…á›á»á”á”á¶á“á‘áŸáŸ”");
            }
        }

        function editRow(id, c, cr, r) {
            editingFileId = id;
            document.getElementById('cashInput').value = c;
            document.getElementById('creditInput').value = cr;
            document.getElementById('remarkInput').value = r;
            document.getElementById('formTitle').innerText = "á€áŸ‚á”áŸ’ášáŸ‚á‘á·á“áŸ’á“á“áŸá™";
            document.getElementById('saveBtn').innerText = "á’áŸ’áœá¾á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–";
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function resetForm() {
            editingFileId = null;
            document.getElementById('cashInput').value = "";
            document.getElementById('creditInput').value = "";
            document.getElementById('remarkInput').value = "";
            document.getElementById('formTitle').innerText = "á€á¶ášáŠá¶á€áŸ‹á”áŸ’ášá¶á€áŸ‹ááŸ’á˜á¸";
            document.getElementById('saveBtn').innerText = "ášá€áŸ’áŸá¶á‘á»á€";
        }

        function filterTransactions() {
            const date = document.getElementById('dateSearch').value;
            if (!date) return renderTable(allTransactions);
            const filtered = allTransactions.filter(item => {
                const itemDate = new Date(item.timestamp).toISOString().split('T')[0];
                return itemDate === date;
            });
            renderTable(filtered);
        }

        window.onload = loadTransactions;
    </script>
</body>
</html>
